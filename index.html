
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Lab Reference</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;shell&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="shell">shell</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#servers" class="toc-h1 toc-link" data-title="Servers">Servers</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#song" class="toc-h2 toc-link" data-title="song">song</a>
                  </li>
                  <li>
                    <a href="#ming" class="toc-h2 toc-link" data-title="ming">ming</a>
                  </li>
                  <li>
                    <a href="#tang" class="toc-h2 toc-link" data-title="tang">tang</a>
                  </li>
                  <li>
                    <a href="#shang" class="toc-h2 toc-link" data-title="shang">shang</a>
                  </li>
                  <li>
                    <a href="#chou" class="toc-h2 toc-link" data-title="chou">chou</a>
                  </li>
                  <li>
                    <a href="#sbol-droplet" class="toc-h2 toc-link" data-title="SBOL Droplet">SBOL Droplet</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#services" class="toc-h1 toc-link" data-title="Services">Services</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#synbiohub" class="toc-h2 toc-link" data-title="SynBioHub">SynBioHub</a>
                  </li>
                  <li>
                    <a href="#sbol-validator-and-converter" class="toc-h2 toc-link" data-title="SBOL Validator and Converter">SBOL Validator and Converter</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#synbiohub" class="toc-h1 toc-link" data-title="SynBioHub">SynBioHub</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#releaser" class="toc-h2 toc-link" data-title="Releaser">Releaser</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#services" class="toc-h1 toc-link" data-title="Services">Services</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#synbiohub" class="toc-h2 toc-link" data-title="SynBioHub">SynBioHub</a>
                  </li>
              </ul>
          </li>
      </ul>
        <ul class="toc-footer">
            <li><a href='http://www.async.ece.utah.edu'>Lab Website</a></li>
            <li><a href='https://github.com/myersresearchgroup/myersresearchgroup.github.io'>Documentation Repository</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='servers'>Servers</h1>
<p>The lab has several servers. 
They are named for Chinese dynasties. 
Each runs a few applications that you should know about.</p>
<h2 id='song'>song</h2>
<p>This server no longer exists.
Its domain name is pointed at <code>tang</code> for SynBioHub reasons. </p>
<h2 id='ming'>ming</h2>
<p>This server no longer exists.</p>
<h2 id='tang'>tang</h2>
<p>This server is under the desk in the corner near the entrance to the lab.
It hosts three important services: SynBioHub, SnapGene, and backups.</p>
<h2 id='shang'>shang</h2>
<p>Shang hosts the website. 
It runs on Wordpress and <code>nginx</code> is used as the web server.</p>
<h2 id='chou'>chou</h2>
<p>Chou hosts Chris&#39; mailserver.</p>
<h2 id='sbol-droplet'>SBOL Droplet</h2>
<p>This is not a physical server in the lab, but it runs the <a href="https://sbolstandard.org">SBOL Standard</a> website.
It also hosts the reference instance of the <a href="https://validator.sbolstandard.org">SBOL Validator</a> and <a href="https://converter.sbolstandard.org">SBOL Converter</a></p>
<h1 id='services'>Services</h1>
<p>The lab computers host a number of valuable services.
Instructions for their care and feeding are shown below.</p>
<h2 id='synbiohub'>SynBioHub</h2>
<p>SynBioHub on this machine runs using docker-compose. 
It does <strong>not</strong> require the SynBioHub container to be rebuilt locally before running
SynBioHub is managed using <code>systemd</code>, with the service name <code>synbiohub.service</code> and unit file located at <code>/etc/systemd/system/synbiohub.service</code>.</p>

<p>To update SynBioHub, follow these steps: </p>

<ol>
<li>Stop the SynBioHub service with <code>systemctl stop synbiohub</code>. </li>
<li>Remove the Docker images you&#39;d like to update with <code>docker rmi &lt;image id(s)&gt;</code>. 
The image id you want can be found using <code>docker images</code>.
You can enter the first 4 characters of the hash instead of the whole thing.</li>
<li>(Optional) If the docker-compose configuration has changed, pull the latest changes by navigating to <code>/root/synbiohub-docker</code> and running <code>git pull</code>. </li>
<li>Start SynBioHub with <code>systemctl start synbiohub</code>. </li>
</ol>

<p>SynBioHub runs on port 7777. 
This port is blocked from external access.
In order to serve SynBioHub, <code>httpd</code> is used.
It listens for HTTPS connections at <code>synbiohub.utah.edu:443</code> and forwards them to the SynBioHub process.
HTTP connections are escalated to HTTPS. 
HTTPS is managed by LetsEncrypt. 
There is a cron job in root&#39;s crontab (<code>crontab -e</code> when root) which should automatically renew the certificate when it expires.</p>

<p>If there is an issue with the cron job, security errors will begin to manifest when users try and access SynBioHub Utah. 
In this case, please do the following:</p>

<ol>
<li>Check that <code>certbot renew</code> can run. 
This command should automatically renew the certificates when the get close to expiration.
If the certificates are not close to expiration, it does nothing.</li>
<li>If the renewal command indicates there is nothing to do, make sure that httpd is restarted with <code>apachectl restart</code>. </li>
<li>If both steps succeed and SynBioHub still cannot be accessed without seeing security errors, please examine the logs at <code>/var/log/httpd/{access,error}_log</code>.</li>
</ol>
<h2 id='sbol-validator-and-converter'>SBOL Validator and Converter</h2>
<p>The validator and converter are really the same application, running twice with a very slightly modified frontend.
Both run on the SBOL droplet in docker containers. 
The container images are automatically built by Travis CI and pushed to Docker Hub on commits to master in the <a href="https://github.com/synbiodex/SBOL-Validator">SBOL Validator</a> repository. 
On the droplet, both applications are run in containers managed by Docker Compose (yes, this is overkill, because they are one container each. Sorry.)
The docker compose files are stored in <code>/opt/validator</code> and <code>/opt/converter</code>, respectively.
Each docker container contains a web server, and compose configuration connects the machine port 9090 to port 80 on the converter and machine port 9000 to port 80 on the validator. 
Systemd is used to make sure the containers are started when the droplet comes back online. 
The systemd service configurations are stored in <code>/etc/systemd/system/validator.service</code> and <code>/etc/systemd/system/converter.service</code>.
You probably won&#39;t need to mess around with those or the docker-compose configurations. 
The requests coming into the droplet for the SBOL standard website and both applications are handled by Caddy. 
Caddy serves the role that nginx does in other projects, but automatically handles HTTPS certificates. 
Caddy&#39;s configuration is stored at <code>/etc/caddy/Caddyfile</code>, and it is also managed by systemd at <code>/etc/systemd/system/caddy.service</code>. 
You might need to touch the Caddyfile, but it is unlikely. 
The Caddyfile contains directives to route all requests from <code>validator.sbolstandard.org</code> to machine port 9000, and for <code>converter.sbolstandard.org</code> to machine port 9090. </p>
<h3 id='updating-anything'>Updating anything</h3>
<p>The systemd configuration files (unitfiles) are set up to automatically pull the latest image on restart, so you can update them with systemctl.</p>
<pre class="highlight plaintext"><code># To update the converter
sudo systemctl restart converter

# To update the validator
sudo systemctl restart validator
</code></pre>
<p>Once the command completes, you can check the status with systemctl as well.</p>
<pre class="highlight plaintext"><code># Check up on the converter
sudo systemctl status converter

# Check on the validator
sudo systemctl status validator
</code></pre><h3 id='debugging-issues'>Debugging issues</h3>
<p>I would start inside the containers (using our friends <code>docker ps</code>, <code>docker exec -it $CONTAINER_NAME /bin/bash</code>), then work out from there.</p>
<h1 id='synbiohub'>SynBioHub</h1>
<p><a href="https://github.com/synbiohub/synbiohub">SynBioHub</a> (called SBH frequently) is a data repository using SBOL.</p>

<p>SynBioHub is packaged into Docker images, which user run alongside images for Virtuoso, ElasticSearch, SBOLExplorer, plugins, and others using Docker Compose. 
Files related to the SynBioHub image are in the <code>docker/</code> directory in the <a href="https://github.com/synbiohub/synbiohub">synbiohub/synbiohub</a> repository. 
The docker-compose configurations are hosted in the <a href="https://github.com/synbiohub/synbiohub-docker">synbiohub/synbiohub-docker</a> repository. They are <strong>layered</strong>, meaning that in order to get the functionality you need you will have to provide multiple files to docker-compose when it starts. This is not well documented, and needs to be. </p>
<h2 id='releaser'>Releaser</h2><h3 id='overview'>Overview</h3>
<p>Keeping the SynBioHub repositories in sync is no small task.
The releaser is a small tool that does some of this.
It is a small Python web application which receives a webhook from the <a href="https://github.com/synbiohub/synbiohub">synbiohub/synbiohub</a> repository when a new release is published.
The releaser creates a pull request in the <a href="https://github.com/synbiohub/synbiohub-docker">synbiohub/synbiohub-docker</a> repository which amends the version specification for the <code>master</code> branch to match the release.
The author of the release is tagged as the reviewer for this PR, and they can then merge it into master, completing the release.
The Docker images should be built and automatically tagged using Travis CI, but this is currently broken for unknown reasons. 
The latest snapshot image can be pulled, tagged with the release version, and pushed to <a href="https://cloud.docker.com/u/synbiohub/repository/docker/synbiohub/synbiohub">Docker Hub</a>.</p>
<pre class="highlight shell tab-shell"><code><span class="c"># Pull the latest snapshot (make sure Travis has pushed it to Docker Hub!)</span>
<span class="gp">$ </span>docker pull synbiohub/synbiohub:snapshot-standalone 

<span class="c"># Tag the snapshot as a release</span>
<span class="gp">$ </span>docker tag synbiohub/synbiohub:snapshot-standalone synbiohub/synbiohub:&lt;version number&gt;-standalone

<span class="c"># Push the tagged version to docker hub</span>
<span class="gp">$ </span>docker push synbiohub/synbiohub:&lt;version number&gt;-standalone
</code></pre><h1 id='services'>Services</h1>
<p>The lab computers host a number of valuable services.
Instructions for their care and feeding are shown below.</p>
<h2 id='synbiohub'>SynBioHub</h2>
<p>SynBioHub on this machine runs using docker-compose. 
It does <strong>not</strong> require the SynBioHub container to be rebuilt locally before running
SynBioHub is managed using <code>systemd</code>, with the service name <code>synbiohub.service</code> and unit file located at <code>/etc/systemd/system/synbiohub.service</code>.</p>

<p>To update SynBioHub, follow these steps: </p>

<ol>
<li>Stop the SynBioHub service with <code>systemctl stop synbiohub</code>. </li>
<li>Remove the Docker images you&#39;d like to update with <code>docker rmi &lt;image id(s)&gt;</code>. 
The image id you want can be found using <code>docker images</code>.
You can enter the first 4 characters of the hash instead of the whole thing.</li>
<li>(Optional) If the docker-compose configuration has changed, pull the latest changes by navigating to <code>/root/synbiohub-docker</code> and running <code>git pull</code>. </li>
<li>Start SynBioHub with <code>systemctl start synbiohub</code>. </li>
</ol>

<p>SynBioHub runs on port 7777. 
This port is blocked from external access.
In order to serve SynBioHub, <code>httpd</code> is used.
It listens for HTTPS connections at <code>synbiohub.utah.edu:443</code> and forwards them to the SynBioHub process.
HTTP connections are escalated to HTTPS. 
HTTPS is managed by LetsEncrypt. 
There is a cron job in root&#39;s crontab (<code>crontab -e</code> when root) which should automatically renew the certificate when it expires.</p>

<p>If there is an issue with the cron job, security errors will begin to manifest when users try and access SynBioHub Utah. 
In this case, please do the following:</p>

<ol>
<li>Check that <code>certbot renew</code> can run. 
This command should automatically renew the certificates when the get close to expiration.
If the certificates are not close to expiration, it does nothing.</li>
<li>If the renewal command indicates there is nothing to do, make sure that httpd is restarted with <code>apachectl restart</code>. </li>
<li>If both steps succeed and SynBioHub still cannot be accessed without seeing security errors, please examine the logs at <code>/var/log/httpd/{access,error}_log</code>.</li>
</ol>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="shell">shell</a>
          </div>
      </div>
    </div>
  </body>
</html>
